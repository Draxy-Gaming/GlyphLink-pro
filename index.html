<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GlyphLink PRO</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Share Tech Mono', monospace; background-color: #020617; overscroll-behavior: none; }
        h1, h2, h3, .brand-font { font-family: 'Orbitron', sans-serif; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .glass-panel { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(16px); border: 1px solid rgba(56, 189, 248, 0.2); }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #0ea5e9; box-shadow: 0 0 20px #0ea5e9; animation: scanning 2s ease-in-out infinite; }
        @keyframes scanning { 0% { top: 10%; opacity: 0; } 50% { opacity: 1; } 100% { top: 90%; opacity: 0; } }
        .neon-text { text-shadow: 0 0 10px rgba(56, 189, 248, 0.6); }
        .holo-btn { background: rgba(56, 189, 248, 0.1); border: 1px solid rgba(56, 189, 248, 0.3); box-shadow: 0 0 15px rgba(56, 189, 248, 0.1); }
        .holo-btn:active { background: rgba(56, 189, 248, 0.3); }
        
        /* Shape definitions for CSS rendering if needed */
        .shape-box { clip-path: inset(0 0 0 0); }
        .shape-tri { clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
        .shape-cir { clip-path: circle(50% at 50% 50%); }
    </style>
</head>
<body class="text-slate-200 antialiased overflow-hidden select-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- SYSTEM CONFIG ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
        }

        const firebaseConfig = {
            apiKey: "AIzaSyABW016QX_pqQbPFi7-wqEoSSIHPOvwdM8",
            authDomain: "glyphlink-pro.firebaseapp.com",
            projectId: "glyphlink-pro",
            storageBucket: "glyphlink-pro.firebasestorage.app",
            messagingSenderId: "1028534875508",
            appId: "1:1028534875508:web:5cdcb3e884da88c8012821"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = 'glyphlink-pro-v1'; 
        const PUBLIC_PATH = `artifacts/${APP_ID}/public/data/glyphs`;
        const GEMINI_KEY = "AIzaSyDRr14gl3bxeyT_6kKA4647QbvWP_VKr8Y"; 

        // --- AUDIO & HAPTIC ENGINE ---
        const sfx = {
            click: () => playTone(1200, 'square', 0.05),
            error: () => playTone(150, 'sawtooth', 0.3),
            success: () => { playTone(800, 'sine', 0.1); setTimeout(() => playTone(1200, 'sine', 0.2), 100); },
            scan: () => playTone(2000, 'sine', 0.05),
            speak: (text) => {
                if ('speechSynthesis' in window) {
                    const u = new SpeechSynthesisUtterance(text);
                    u.pitch = 0.8; u.rate = 1.1;
                    window.speechSynthesis.speak(u);
                }
            }
        };

        const playTone = (freq, type, duration) => {
            if (navigator.vibrate) navigator.vibrate(10);
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ctx.currentTime);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + duration);
        };

        const Icon = ({ path, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const paths = {
            box: <rect width="18" height="18" x="3" y="3" rx="2" />,
            tri: <path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />,
            cir: <circle cx="12" cy="12" r="10" />,
            cam: <><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>,
            plus: <><path d="M5 12h14"/><path d="M12 5v14"/></>,
            list: <><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>,
            close: <><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="18" y2="6"/></>,
            trash: <path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />,
            edit: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />,
            sparkles: <path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z" />,
        };

        const LinkLens = ({ glyphs }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [activeGlyph, setActiveGlyph] = useState(null);
            const [status, setStatus] = useState('READY');

            useEffect(() => {
                let stream = null;
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: {ideal:1920} } })
                    .then(s => { stream = s; if(videoRef.current) videoRef.current.srcObject = s; })
                    .catch(e => console.log("Cam Error"));
                return () => stream?.getTracks().forEach(t => t.stop());
            }, []);

            const scan = async () => {
                if (status === 'SCANNING') return;
                sfx.click();
                setStatus('SCANNING');
                try {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    const b64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];

                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST',
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Find alphanumeric ID (e.g. ALPHA-1). Return ONLY code or 'NONE'." }, { inlineData: { mimeType: "image/jpeg", data: b64 } }] }] })
                    });
                    const data = await res.json();
                    const code = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim().toUpperCase();

                    if (code && code !== 'NONE') {
                        const match = glyphs.find(g => code.includes(g.code) || g.code.includes(code));
                        if (match) {
                            sfx.success();
                            sfx.speak(`Target Acquired. ${match.code}`);
                            setActiveGlyph(match);
                        } else { sfx.error(); throw new Error("UNKNOWN SIGNAL"); }
                    } else { sfx.error(); throw new Error("NO GLYPH"); }
                } catch (e) {
                    // Visual feedback only
                } finally { setStatus('READY'); }
            };

            return (
                <div className="relative h-full bg-black">
                    <video ref={videoRef} autoPlay playsInline muted className="h-full w-full object-cover opacity-60" />
                    <canvas ref={canvasRef} className="hidden" />
                    <div className="absolute inset-0 pointer-events-none" style={{backgroundImage: 'linear-gradient(rgba(14,165,233,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(14,165,233,0.1) 1px, transparent 1px)', backgroundSize: '40px 40px'}}></div>
                    
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div className="w-72 h-72 border border-sky-500/30 rounded-full relative animate-pulse">
                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 border-2 border-sky-400/50 rounded-full"></div>
                             {status === 'SCANNING' && <div className="scan-line"></div>}
                        </div>
                    </div>

                    <div className="absolute bottom-0 w-full p-8 safe-pb flex flex-col items-center bg-gradient-to-t from-black via-black/90 to-transparent">
                        {activeGlyph ? (
                            <div className="glass-panel p-6 rounded-3xl w-full max-w-sm animate-in slide-in-from-bottom border-l-4 border-emerald-500">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-3xl font-black brand-font text-white">{activeGlyph.code}</h3>
                                    <button onClick={() => {sfx.click(); setActiveGlyph(null);}}><Icon path={paths.close} className="text-slate-400" /></button>
                                </div>
                                <div className="bg-black/50 p-4 rounded-xl mb-4 font-mono text-xs text-sky-300 break-all">{activeGlyph.content}</div>
                                <button onClick={() => {sfx.click(); window.open(activeGlyph.content, '_blank');}} className="w-full py-4 bg-emerald-600 rounded-xl font-bold tracking-[0.2em] text-xs shadow-[0_0_20px_rgba(5,150,105,0.4)]">ESTABLISH LINK</button>
                            </div>
                        ) : (
                            <button onClick={scan} className={`w-24 h-24 rounded-full border-2 flex items-center justify-center transition-all ${status === 'SCANNING' ? 'border-sky-400 bg-sky-900/20' : 'border-white/20 hover:border-sky-500'}`}>
                                <div className={`w-16 h-16 rounded-full transition-all ${status === 'SCANNING' ? 'bg-sky-400 animate-ping' : 'bg-white shadow-[0_0_30px_rgba(255,255,255,0.2)]'}`}></div>
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const Forge = ({ user, editData, onComplete }) => {
            const [code, setCode] = useState(editData?.code || '');
            const [content, setContent] = useState(editData?.content || '');
            const [shape, setShape] = useState(editData?.shape || 'Box');
            const [busy, setBusy] = useState(false);

            useEffect(() => { if(editData) { setCode(editData.code); setContent(editData.content); setShape(editData.shape); } }, [editData]);

            const autoGen = async () => {
                if(busy) return;
                sfx.click();
                setBusy(true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`, {
                        method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: `Generate one 2-word sci-fi code (e.g. VOID-X) for: "${content}". Return ONLY the code.` }] }] })
                    });
                    const data = await res.json();
                    const gen = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim().toUpperCase();
                    setCode(gen || 'ERR-GEN');
                    sfx.success();
                } catch(e) { sfx.error(); } finally { setBusy(false); }
            };

            const submit = async (e) => {
                e.preventDefault();
                sfx.click();
                setBusy(true);
                try {
                    let finalCode = code.trim().toUpperCase();
                    if (!finalCode) await autoGen(); // Retry gen if empty
                    
                    await db.collection(PUBLIC_PATH).doc(finalCode).set({
                        code: finalCode, content, shape,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        creator: user.uid
                    });
                    sfx.success();
                    sfx.speak("Data Inscribed");
                    alert("SAVED");
                    if (onComplete) onComplete();
                    else { setCode(''); setContent(''); }
                } catch(e) { sfx.error(); alert("ERR"); } finally { setBusy(false); }
            };

            return (
                <div className="p-8 h-full flex flex-col pt-12 overflow-y-auto">
                    <h1 className="text-4xl font-black brand-font text-white mb-8 neon-text">{editData ? 'REWRITE' : 'FORGE'}</h1>
                    <form onSubmit={submit} className="space-y-8">
                        <div>
                            <label className="text-[10px] font-bold text-sky-500 tracking-[0.2em] uppercase mb-3 block">Geometric Signature</label>
                            <div className="grid grid-cols-3 gap-4">
                                {['Box', 'Triangle', 'Circle'].map(s => (
                                    <button key={s} type="button" onClick={() => {sfx.click(); setShape(s);}} className={`p-4 rounded-xl border flex flex-col items-center gap-2 transition-all ${shape === s ? 'bg-sky-500/20 border-sky-400 text-sky-400 shadow-[0_0_15px_rgba(56,189,248,0.2)]' : 'bg-slate-900 border-slate-800 text-slate-500'}`}>
                                        <Icon path={paths[s === 'Box' ? 'box' : s === 'Triangle' ? 'tri' : 'cir']} />
                                        <span className="text-[9px] uppercase font-bold">{s}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label className="text-[10px] font-bold text-sky-500 tracking-[0.2em] uppercase mb-2 block">Payload</label>
                            <textarea value={content} onChange={e => setContent(e.target.value)} className="w-full bg-slate-900 border border-slate-800 rounded-2xl p-5 text-sm font-mono text-white focus:border-sky-500 outline-none transition-all holo-btn" placeholder="Data..." rows="3" required />
                        </div>

                        <div className="relative">
                             <label className="text-[10px] font-bold text-sky-500 tracking-[0.2em] uppercase mb-2 block">Designation</label>
                             <div className="flex gap-2">
                                <input value={code} onChange={e => setCode(e.target.value.toUpperCase())} className="flex-1 bg-slate-900 border border-slate-800 rounded-2xl p-5 text-xl font-bold tracking-widest text-white focus:border-sky-500 outline-none holo-btn" placeholder="AUTO-GEN" />
                                <button type="button" onClick={autoGen} className="p-4 bg-slate-800 border border-slate-700 rounded-2xl text-sky-400 hover:bg-slate-700"><Icon path={paths.sparkles} /></button>
                             </div>
                        </div>

                        <button disabled={busy} className="w-full py-6 bg-sky-600 rounded-2xl font-black text-xs tracking-[0.4em] text-white shadow-xl shadow-sky-900/40 active:scale-95 transition-all">
                            {busy ? "PROCESSING..." : editData ? "OVERWRITE" : "INSCRIBE"}
                        </button>
                    </form>
                </div>
            );
        };

        const Registry = ({ glyphs, onEdit, onDelete }) => (
            <div className="p-6 pt-12 h-full flex flex-col">
                <h1 className="text-3xl font-black brand-font text-white mb-8 neon-text">ARCHIVE</h1>
                <div className="flex-1 overflow-y-auto space-y-3 pb-32">
                    {glyphs.map(g => (
                        <div key={g.id} className="bg-slate-900/60 border border-slate-800/80 p-5 rounded-2xl flex items-center gap-4 group hover:border-sky-500/40 transition-all">
                             <div className="w-10 h-10 rounded-lg bg-slate-950 flex items-center justify-center text-slate-600">
                                <Icon path={paths[g.shape === 'Box' ? 'box' : g.shape === 'Triangle' ? 'tri' : 'cir']} />
                             </div>
                             <div className="flex-1 min-w-0">
                                <h4 className="font-black text-white tracking-widest text-lg">{g.code}</h4>
                                <p className="text-[10px] text-slate-500 truncate font-mono">{g.content}</p>
                             </div>
                             <div className="flex gap-1">
                                <button onClick={() => {sfx.click(); onEdit(g);}} className="p-2 text-slate-500 hover:text-sky-400"><Icon path={paths.edit} className="w-4 h-4" /></button>
                                <button onClick={() => {sfx.click(); onDelete(g.id);}} className="p-2 text-slate-500 hover:text-rose-500"><Icon path={paths.trash} className="w-4 h-4" /></button>
                             </div>
                        </div>
                    ))}
                    <div className="h-20"></div>
                </div>
            </div>
        );

        const App = () => {
            const [view, setView] = useState('LENS');
            const [glyphs, setGlyphs] = useState([]);
            const [user, setUser] = useState(null);
            const [editingGlyph, setEditingGlyph] = useState(null);

            useEffect(() => {
                auth.signInAnonymously().then(c => {
                    setUser(c.user);
                    db.collection(PUBLIC_PATH).orderBy('timestamp', 'desc').onSnapshot(s => setGlyphs(s.docs.map(d => ({...d.data(), id: d.id}))));
                });
            }, []);

            const handleDelete = async (id) => {
                if(confirm("DELETE NEURAL LINK?")) {
                    await db.collection(PUBLIC_PATH).doc(id).delete();
                    sfx.error(); // Deletion sound
                }
            };

            const handleEdit = (glyph) => {
                setEditingGlyph(glyph);
                setView('FORGE');
            };

            return (
                <div className="h-screen w-full flex flex-col bg-[#020617]">
                    <main className="flex-1 relative overflow-hidden">
                        {view === 'LENS' && <LinkLens glyphs={glyphs} />}
                        {view === 'FORGE' && <Forge user={user} editData={editingGlyph} onComplete={() => {setEditingGlyph(null); setView('REGISTRY');}} />}
                        {view === 'REGISTRY' && <Registry glyphs={glyphs} onEdit={handleEdit} onDelete={handleDelete} />}
                    </main>
                    <nav className="h-24 bg-slate-950/90 backdrop-blur-xl border-t border-slate-800 flex justify-around items-center px-6 safe-pb z-50">
                        <button onClick={() => {sfx.click(); setEditingGlyph(null); setView('FORGE');}} className={`flex flex-col items-center gap-1 ${view === 'FORGE' ? 'text-sky-400' : 'text-slate-600'}`}><Icon path={paths.plus} className="w-5 h-5"/><span className="text-[8px] font-bold tracking-widest">FORGE</span></button>
                        <button onClick={() => {sfx.scan(); setView('LENS');}} className={`w-18 h-18 -mt-10 rounded-2xl rotate-45 border-4 border-[#020617] flex items-center justify-center transition-all ${view === 'LENS' ? 'bg-sky-500 shadow-[0_0_20px_rgba(56,189,248,0.4)] scale-110' : 'bg-slate-800'}`}><div className="-rotate-45 text-white"><Icon path={paths.cam} className="w-8 h-8"/></div></button>
                        <button onClick={() => {sfx.click(); setView('REGISTRY');}} className={`flex flex-col items-center gap-1 ${view === 'REGISTRY' ? 'text-sky-400' : 'text-slate-600'}`}><Icon path={paths.list} className="w-5 h-5"/><span className="text-[8px] font-bold tracking-widest">DATA</span></button>
                    </nav>
                </div>
            );
        };
        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>


